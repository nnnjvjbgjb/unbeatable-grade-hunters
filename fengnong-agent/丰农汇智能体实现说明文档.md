## **三. 实现说明（Engineering Details）**

> 本章覆盖：**技术栈选型 → MCP 协议落地 → 核心模块实现 → 数据库存储 → 核心算法**。
> 约定：出现英文术语时，**均附中文释义**，避免阅读阻碍；示例代码与数据结构保持**可落地**与**可解释**。

------

### **3.1 技术栈（Tech Stack & Rationale）**

> 目标：**快**速落地 MVP、**稳**定可演示、**易**于并行协作与后续扩展。

| 层级                  | 技术                                                 | 选择理由                                                     | 可替代方案                 | 我们的取舍                     |
| --------------------- | ---------------------------------------------------- | ------------------------------------------------------------ | -------------------------- | ------------------------------ |
| 前端 Web              | **React / Next.js**                                  | 生态成熟、路由与状态管理完善；便于做对话区、时间线、证据清单与下载中心；集成浏览器**Web Speech API**（ASR/TTS）成本低 | Vue/Nuxt、SvelteKit        | 先上 Next.js，后续可移植       |
| 编排层 Orchestrator   | **Node.js + TypeScript**                             | 与前端同语系；TS 强类型确保 `timeline/evidence/plan` 结构稳定；良好并发 I/O | Python（FastAPI）          | 团队 JS 基因更强，优先 Node    |
| 工具层（MCP Servers） | **Python + FastAPI/Starlette**                       | 调第三方 API、数据处理舒适；SSE（Server-Sent Events，服务器推送）实现简单 | Node/Express、Go/Fiber     | Weather/Commerce 先用 Python   |
| 数据层                | **CSV/JSON（MVP） → SQLite（进阶）**                 | MVP 零依赖；进阶 SQLite 获得查询与一致性                     | DuckDB、PostgreSQL         | 先文件制，随时切 SQLite        |
| 语音                  | **Web Speech API**（ASR：语音→文字；TTS：文字→语音） | 浏览器原生、无需服务端                                       | 科大讯飞、阿里云、Edge-TTS | 课堂演示先原生，后续可升级     |
| 工程                  | `.env.local(.example)`、`README`、`run.sh`           | 一键启动、配置分发、便于课堂验收                             | Docker Compose、CI/CD      | 可选加入 Actions 做 Lint/Build |

**工程基线**

- **一键启动**：前端 `npm run dev`；编排层 `npm run dev`；MCP 工具 `python server.py`。
- **可观测性**：统一日志（请求 ID、工具名、耗时、`mock` 标记、错误码）。
- **安全**：写入仅限 `apps/web/sandbox/**`（沙盒目录），越权立即失败并记录到时间线（Timeline）。
- **可解释**：每次响应**强制**携带 `timeline[]` + `evidence[]`。
- **降级**：外部 API 失败自动 **mock 回退**（模拟数据），并在 `evidence` 中标注 `mock=true` 与时间戳 `ts`。

------

# 3.2 MCP 框架应用（Protocols in Practice）

## MCP（模型上下文协议）概述

**MCP（Model Context Protocol）**：将能力封装为**工具（Tool）**，以**统一协议**暴露调用入口，实现类似"函数调用"的智能体调用机制。

## 通信方式：SSE（服务器推送）

- 编排层向 MCP Server 的 `/messages` 发送 **`tool.call`** 请求（JSON-RPC 风格）
- MCP 工具返回结构化 **`result`**，失败则返回 **`error`**
- 全链路保持**结构化与可追踪**（为时间线与证据服务）

## 请求/响应示例

```json
// Request（发往 MCP Server 的 SSE 帧）
{
  "jsonrpc": "2.0",
  "id": "req-20251023-001",
  "method": "tool.call",
  "params": {
    "tool_name": "get_forecast",
    "parameters": { "city": "武汉", "days": 7 }
  }
}

// Response（MCP 返回的 SSE 帧）
{
  "jsonrpc": "2.0",
  "id": "req-20251023-001",
  "result": {
    "city": "武汉",
    "days": 7,
    "summary": "有两天中雨；最高温34℃；无霜冻/大风预警。",
    "mock": false,                 // 是否使用模拟数据（降级）
    "ts": "2025-10-20T10:20:30Z"   // 数据时间戳（证据展示用）
  }
}
```

## **3.3 核心模块实现（Modules & Interfaces）**

### **总体目标**

将"口语问题"稳定地转换为"可下载的产物 + 可解释的证据链"

### **核心链路**

Planner（计划器） → Executor（执行器） → Memory（记忆） → RAG（检索增强） → Output（输出合成）

### **（1）Planner｜计划器**

#### **作用**

从自然语言中提取关键参数和意图，生成"最小可行"的步骤集合（最多 4 步）

#### **输入输出**

- **输入**：`query`（口语化请求）、`memory`（记忆数据）、`rag`（检索证据片段）
- **输出**：`Plan`（计划 JSON），包含 steps[]（≤4 步）和 guardrails（护栏规则）

#### **每步包含内容**

- 工具名（如 weather.get_forecast）
- 参数（JSON 格式）
- 设计动机（reason 说明）

#### **生成规则**

- **参数补全**：优先使用记忆数据（如 region=武汉、prefer_local=true）
- **必要澄清**：仅对缺失"高风险参数"（如收货地址）触发澄清
- **证据优先**：RAG 找到相关事实时在 reason 中备注"来源"
- **降级保障**：外部 API 步骤默认允许 mock 降级

### **（2）Executor｜执行器**

#### **作用**

依次执行 Plan.steps，确保安全、可观察、可降级

#### **执行流程**

参数校验 → MCP（SSE）调用工具 → 标准化结果 → 生成时间线条目 → 收集证据与产物

#### **健壮性保障**

- **超时控制**：3 秒超时 → 2 次重试 → 熔断保护
- **降级机制**：失败时自动 mock（若允许），evidence 中标注 mock=true
- **统一日志**：记录请求 ID、工具名、耗时、错误码、mock 标记

#### **写入安全**

- **沙盒限制**：所有写入必须在 `apps/web/sandbox/**`
- **越权处理**：发现越权路径立即失败，Timeline 中 ❌ 标注

#### **时间线条目（每步一条）**

- name（工具名）
- ok（执行状态）
- latency_ms（耗时）
- summary（结果摘要）
- artifact（产物路径）

### **（3）Memory｜记忆系统**

#### **目的**

减少重复输入，提升多轮对话承接能力，优化排序与默认参数

#### **数据结构**

- **短期会话记忆**：最近 N 轮摘要（问题/计划/结论/时间）
- **长期偏好卡**：region、crop、price_sensitivity、prefer_local、prefer_season 等

#### **存储位置**

```
apps/web/sandbox/memory/<userId>.json
```

#### **接口策略**

- `load/save`：记忆读取/保存
- `decay`：静默 7 天自动降权/裁剪旧会话
- `reset`：手动清空记忆
- **智能应用**：Planner 自动补全参数，Commerce 按偏好动态调权

### **（4）RAG｜检索增强**

#### **目标**

回答前先找证据，UI 透明展示数据来源、更新时间、mock 状态

#### **数据源**

- `products.csv`：商品价格、库存、产地、当季、本地直发标签
- `crops.json`：作物生育期、注意事项、14 日待办模板、免责声明
- `faq.md`：常见问答与数据更新时间

#### **处理管线**

- **别名归一**：番茄=西红柿、土豆=马铃薯等
- **关键词召回**：按 region/crop/season/max_price 过滤数据
- **证据打包**：evidence[] 列出文件名与更新时间

#### **核心原则**

没有证据不下强结论，所有回答必须包含 evidence 段落

### **（5）Output Synthesizer｜输出合成**

#### **目标**

将执行结果组合成可理解、可复现、可下载的完整交付物

#### **输出组件**

- **Answer**：先结论后建议（3±1 条动作化建议）
- **Timeline**：显示工具名、耗时、状态、参数摘要、产物路径
- **Evidence**：列出数据来源、更新时间、mock 状态
- **Artifacts**：可下载文件的相对路径

#### **示例：G2 物美价廉 + 订单草稿**

```json
{
  "answer": "已筛出本地直发、当季且 ≤8 元/斤的有机番茄，生成订单草稿；建议：1) 优先选均价以下且库存健康的两件；2) 时效敏感勾选冷链；3) 下单前核对地址",
  "timeline": [
    {
      "name": "commerce.catalog_search",
      "ok": true,
      "latency_ms": 120,
      "summary": "命中 8 件，本地直发 3 件，均价 7.6"
    },
    {
      "name": "commerce.create_order_draft",
      "ok": true, 
      "latency_ms": 45,
      "summary": "写入 sandbox/orders/DRAFT-20251023-001.json"
    }
  ],
  "evidence": ["products.csv(updated:2025-10-18)"],
  "artifacts": ["apps/web/sandbox/orders/DRAFT-20251023-001.json"]
}
```

## **3.4 数据库设计（Data Model & Storage）**

### **目标**

- **MVP** 使用 **CSV/JSON** 快速落地；
- **进阶版本** 切换 **SQLite**（单文件轻量数据库）以获得更好的查询与一致性。
- **对外接口保持不变**，仅替换数据访问层（DAO）。

------

### **（A）MVP：CSV/JSON 文件**

#### **`products.csv`（商品表）**

| 字段       | 说明             | 示例           |
| ---------- | ---------------- | -------------- |
| id         | 商品唯一标识     | `P001`         |
| title      | 商品名称         | 有机番茄       |
| price      | 价格（元/斤）    | `8.5`          |
| stock      | 库存数量         | `120`          |
| origin     | 产地             | 湖北武汉       |
| tags       | 标签（逗号分隔） | 有机,当季,本地 |
| season     | 当季标签         | 夏季           |
| ship_from  | 发货地           | 武汉           |
| updated_at | 更新时间         | `2025-10-20`   |

#### **`crops.json`（作物规则模板）**

```json
{
  "水稻": {
    "分蘖期": {
      "todos_14d": ["追施分蘖肥", "浅水灌溉", "病虫害巡查"],
      "cautions": ["避免深水淹苗", "注意稻飞虱防治"],
      "disclaimer": "本建议仅供参考，具体操作请咨询当地农技人员"
    }
  }
}
```

### **常用查询**

```sql
-- 本地直发 + 当季 + 价格上限
SELECT *
FROM products
WHERE ship_from = '武汉'
  AND season = '当季'
  AND price <= 8.0
ORDER BY price ASC
LIMIT 10;
```

### **迁移策略**

- **接口兼容**：`catalog_search` 等接口保持不变。
- **数据层切换**：先读 **CSV**，后改读 **SQL**（仅替换 **DAO** 层）。
- **证据增强**：在 `evidence[]` 中补充 `updated_at`，用于判断结果新鲜度。

------

### **名词释义**

- **CSV**：逗号分隔文本表格，Excel 可直接打开。
- **JSON**：结构化数据格式，跨语言通用。
- **SQLite**：单文件轻量数据库，无需独立服务，适合课程/小型应用。

## **3.5 核心算法（Core Algorithms & Rules）**

> 追求“**能解释**、**可复现**、**可调参**”的工程风格：所有结论都能回溯到数据与公式；所有权重都能来自记忆（长期偏好卡），并在 UI 中可见。

------

### **（A）意图解析（Intent Parsing）**

**目标**：把口语化请求映射为标准化参数，供 Planner 生成最小可执行计划（≤4 步）。

**提取参数**

- **基础**：`city/region`（地区）、`crop`（作物）、`stage`（生育期）
- **消费**：`max_price`（上限价）、`prefer_local`（本地直发偏好）、`prefer_season`（当季偏好）
- **交易**：`buyer/seller`、`stock`、`price`、`address`

**解析方法**

- **正则 + 词典匹配**：识别 `≤8 元/斤`、`本地直发`、`有机番茄` 等口语片段
- **别名归一**：`番茄=西红柿`、`土豆=马铃薯` …
- **记忆补全**：缺省项用 `sandbox/memory/<userId>.json` 的 `prefs` 补齐（如默认城市/作物/偏好）
- **必要追问**：仅对**高风险参数**（如收货地址）触发澄清，尽量不打断主流程

**输出**

- **标准化 JSON**：交给 Planner 进行步骤合成与参数校验

------

### **（B）“物美价廉”排序算法（消费者侧）**

> 目标：在“更低价格（Price）”“就近发货（Locality）”“当季新鲜（Seasonality）”“库存健康（Stock）”之间做**可解释**的平衡，并依据**长期偏好卡**动态调权。
> 依赖数据：`products.csv / products（SQLite）`；地区均价 `local_avg` 由同区域、同品类候选集计算。

------

#### B.1 指标定义与标准化

**价格评分（PriceScore）**

- **范围**：0到1之间

- **计算逻辑**：基于商品价格与本地平均价格的比较

- 评分规则

  ：

  - 价格等于本地均价时得0.5分
  - 价格低于均价越多，得分越高（最高1分）
  - 价格高于均价越多，得分越低（最低0分）

- **目的**：鼓励选择价格更实惠的商品

**本地直发评分（Locality）**

- **取值**：0或1

- 评分规则

  ：

  - 商品发货地与用户所在地区一致：得1分
  - 发货地与用户地区不一致：得0分

- **目的**：优先推荐本地商品，缩短配送时间

**当季新鲜评分（Seasonality）**

- **取值**：0或1

- 评分规则

  ：

  - 商品属于当季产品：得1分
  - 商品非当季产品：得0分

- **目的**：确保商品新鲜度和最佳食用品质

**库存健康评分（StockHealthy）**

- **范围**：0到1之间

- **计算逻辑**：基于商品库存数量的逻辑函数

- 评分规则

  ：

  - 库存充足时得分接近1
  - 库存紧张时得分接近0
  - 中等库存量得中等分数

- **目的**：避免推荐库存紧张可能缺货的商品

------

#### **B.2 总分计算与权重配置**

**综合评分公式**
---总分 = 价格权重 × 价格评分 + 本地权重 × 本地评分 + 当季权重 × 当季评分 + 库存权重 × 库存评分

**权重配置机制**

- **权重来源**：从用户长期偏好文件中读取

- 个性化配置

  ：

  - **价格敏感型用户**：提高价格权重（如0.5），降低其他权重
  - **时效敏感型用户**：提高本地直发权重（如0.4）
  - **品质优先型用户**：提高当季新鲜权重（如0.35）
  - **均衡型用户**：各权重均匀分配（如各0.25）

- **默认配置**：价格权重0.4，本地权重0.25，当季权重0.2，库存权重0.15

**可解释性与透明度**

- **分数展示**：前端商品卡片展示各项得分和最终总分
- **权重说明**：明确标注影响排序的主要因素
- **个性化提示**：根据用户偏好类型显示"优先考虑价格"或"优先考虑新鲜度"等提示
- **排序依据**：用户可查看每个商品的详细评分构成，理解推荐理由

#### **B.3 本地均价与溢价提示**

- **本地均价（local_avg）**：同区域同品类候选的均价（去极值/去空值）

```sql
-- 计算本地均价（示例：武汉，有机番茄）
SELECT AVG(price) AS local_avg
FROM products
WHERE ship_from='武汉' AND title LIKE '%有机番茄%';
```

#### **B.4 边界与稳健性**

- **数据缺失**：`local_avg` 缺失时，`PriceScore=0.5` 兜底，并在 `evidence[]` 标注“均价缺失（mock 规则）”。
- **极值处理**：计算本地均价时对异常高/低价做**截尾（trim）**或使用**中位数**作稳健估计。
- **稀疏地区**：本地候选极少时回退到“同省/相邻市”计算均价，并在证据中写明**回退层级**。
- **价格单位归一**：统一到“元/斤”；若数据源单位不一，先做换算并记录**转换规则**。
- **负库存/异常值**：过滤并在 `timeline` 中输出**异常说明**。
- **可解释权重**：将 `α/β/γ/δ` 与用户偏好绑定（来自 `sandbox/memory/<userId>.json`），在前端显示当前权重。
- **稳定性日志**：记录请求 ID、样本量、截尾比例、回退层级与是否 mock，便于复盘。

------

#### **B.5 输出与 UI 呈现**

- 卡片标签

  ：

  - `本地`（Locality=1）
  - `当季`（Seasonality=1）
  - `库存健康度：{0~1}`（可显示为 0–100%）
  - `溢价%`：贵/便宜 X%（与 `local_avg` 联动）

- **排序细则**：列表按 `totalScore(S)` **降序**；分数接近时按**价格升序**，再按**库存降序**。

- 证据链

  ：在结果底部展示

  - `products.csv(updated: YYYY-MM-DD)`
  - `local_avg` 的样本量、截尾策略说明
  - 若有回退或 mock，显式标注：`fallback=省级` / `mock=true`

- **可调面板（可选）**：允许用户调整 `α/β/γ/δ` 并实时重排，以教学/演示“可解释推荐”。

------

#### **B.6 示例（简化）**

- **环境**：`region=武汉`，`local_avg=7.6` 元/斤；权重 `α=0.4, β=0.25, γ=0.2, δ=0.15`

- 候选

  ：

  - **A**：`price=7.2`、**本地**、**当季**、`stock=100` → 各项均衡，高分
  - **B**：`price=7.8`、非本地、**当季**、`stock=200` → 价格略高但库存优
  - **C**：`price=6.9`、**本地**、非当季、`stock=20` → 价低但库存偏低、非当季

- 排序结果

  ：

  ```
  A > B > C
  ```

  - 原因：A 在**价格、本地、当季**三项上更均衡；B 依靠库存与当季拉分；C 虽便宜但受库存与非当季影响